################################################################################
# üöÄ SZYBKI DEPLOY NA OVH - KROK PO KROKU
################################################################################

=== KROK 1: PRZE≈öLIJ NAPRAWIONY SKRYPT (z Windows PowerShell) ===

scp C:\Users\48501\Desktop\mrd\start_production.sh ubuntu@51.83.131.142:/workspace/mrd/


=== KROK 2: ZALOGUJ SIƒò NA SERWER ===

ssh ubuntu@51.83.131.142


=== KROK 3: USU≈É Z≈ÅE REPO I URUCHOM SKRYPT ===

cd /workspace/mrd

# Usu≈Ñ problematyczne repo deadsnakes
sudo add-apt-repository --remove ppa:deadsnakes/ppa -y

# Nadaj uprawnienia
chmod +x start_production.sh

# Uruchom!
sudo ./start_production.sh


=== ALTERNATYWNIE: MANUALNY INSTALL BEZ SKRYPTU ===

# 1. Sprawd≈∫ Python (powinien byƒá 3.12+)
python3 --version

# 2. Zainstaluj podstawowe narzƒôdzia
sudo apt-get update
sudo apt-get install -y python3-venv python3-dev python3-pip nginx certbot python3-certbot-nginx supervisor sqlite3 ffmpeg git

# 3. Utw√≥rz venv
cd /workspace/mrd
python3 -m venv .venv
source .venv/bin/activate

# 4. Zainstaluj pakiety
pip install --upgrade pip
pip install -r requirements.txt

# 5. Utw√≥rz bazƒô danych
sqlite3 mem.db << 'EOF'
CREATE TABLE IF NOT EXISTS stm (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id TEXT NOT NULL, role TEXT NOT NULL, content TEXT NOT NULL, timestamp REAL NOT NULL, ttl INTEGER DEFAULT 1800);
CREATE INDEX idx_stm_user ON stm(user_id);
CREATE INDEX idx_stm_timestamp ON stm(timestamp);
CREATE TABLE IF NOT EXISTS ltm (id INTEGER PRIMARY KEY AUTOINCREMENT, fact TEXT NOT NULL UNIQUE, source TEXT, confidence REAL DEFAULT 0.8, importance REAL DEFAULT 0.5, category TEXT, tags TEXT, embedding BLOB, created_at REAL NOT NULL, last_accessed REAL, access_count INTEGER DEFAULT 0);
CREATE INDEX idx_ltm_fact ON ltm(fact);
CREATE TABLE IF NOT EXISTS psyche_state (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id TEXT NOT NULL, mood TEXT, energy REAL, creativity REAL, confidence REAL, emotions TEXT, cognitive_load REAL, timestamp REAL NOT NULL);
CREATE TABLE IF NOT EXISTS episodes (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id TEXT NOT NULL, title TEXT, summary TEXT, content TEXT, importance REAL DEFAULT 0.5, embedding BLOB, created_at REAL NOT NULL, consolidated INTEGER DEFAULT 0);
CREATE TABLE IF NOT EXISTS procedures (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT NOT NULL UNIQUE, description TEXT, steps TEXT, success_rate REAL DEFAULT 0.5, times_used INTEGER DEFAULT 0, created_at REAL NOT NULL);
.quit
EOF

# 6. Utw√≥rz .env
cat > .env << 'ENVEOF'
AUTH_TOKEN=ssjjMijaja6969
WORKSPACE=/workspace/mrd
MEM_DB=/workspace/mrd/mem.db
UPLOAD_DIR=/workspace/mrd/out/uploads
LLM_BASE_URL=https://api.deepinfra.com/v1/openai
LLM_API_KEY=your_key_here
LLM_MODEL=Qwen/QwQ-32B-Preview
LLM_TIMEOUT=60
STM_MAX_TURNS=400
LTM_MIN_CONF=0.35
RATE_LIMIT_PER_MINUTE=160
ENVEOF

# 7. Konfiguracja Nginx
sudo tee /etc/nginx/sites-available/mordzix << 'NGINX'
server {
    listen 80;
    server_name mordxixai.xyz www.mordxixai.xyz;
    client_max_body_size 100M;
    
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
NGINX

sudo ln -sf /etc/nginx/sites-available/mordzix /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default
sudo nginx -t
sudo systemctl reload nginx

# 8. SSL Certbot
sudo certbot --nginx -d mordxixai.xyz -d www.mordxixai.xyz --non-interactive --agree-tos --email admin@mordxixai.xyz --redirect

# 9. Supervisor
sudo tee /etc/supervisor/conf.d/mordzix.conf << 'SUPER'
[program:mordzix]
directory=/workspace/mrd
command=/workspace/mrd/.venv/bin/gunicorn -w 4 -k uvicorn.workers.UvicornWorker -b 127.0.0.1:8080 --timeout 120 app:app
autostart=true
autorestart=true
stderr_logfile=/workspace/mrd/logs/supervisor_error.log
stdout_logfile=/workspace/mrd/logs/supervisor_out.log
user=ubuntu
environment=PATH="/workspace/mrd/.venv/bin"
SUPER

sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start mordzix

# 10. Sprawd≈∫ status
sudo supervisorctl status mordzix
curl http://localhost:8080/health


=== TEST KO≈ÉCOWY ===

curl https://mordxixai.xyz/health
curl https://mordxixai.xyz/api

# Otw√≥rz w przeglƒÖdarce:
https://mordxixai.xyz/


################################################################################
# ‚úÖ GOTOWE!
################################################################################
