<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mordzix AI - Full Power</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0a0e27;
            --card: #1a1f3a;
            --accent: #00ff9f;
            --text: #e0e0e0;
            --dim: #8a8a8a;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: var(--card);
            padding: 15px 25px;
            border-bottom: 2px solid var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo { font-size: 24px; font-weight: bold; color: var(--accent); }
        .stats { font-size: 14px; color: var(--dim); }
        .container { flex: 1; display: flex; overflow: hidden; }
        .sidebar {
            width: 300px;
            background: var(--card);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #333;
        }
        .conv-item {
            padding: 12px;
            margin: 8px 0;
            background: rgba(0,255,159,0.1);
            border-radius: 8px;
            cursor: pointer;
            border-left: 3px solid var(--accent);
        }
        .conv-item:hover { background: rgba(0,255,159,0.2); }
        .new-chat {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: var(--bg);
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .main { flex: 1; display: flex; flex-direction: column; }
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .msg {
            margin: 15px 0;
            display: flex;
            gap: 12px;
        }
        .msg.user { flex-direction: row-reverse; }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }
        .msg.user .avatar { background: #667eea; }
        .content {
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 12px;
            line-height: 1.6;
        }
        .msg.user .content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .msg.assistant .content {
            background: var(--card);
            border: 1px solid var(--accent);
        }
        .input-area {
            padding: 20px;
            background: var(--card);
            border-top: 1px solid #333;
        }
        .input-wrap { display: flex; gap: 10px; }
        textarea {
            flex: 1;
            background: var(--bg);
            border: 2px solid var(--accent);
            color: var(--text);
            padding: 12px;
            border-radius: 10px;
            resize: none;
            min-height: 60px;
            font-size: 15px;
        }
        button {
            padding: 12px 24px;
            background: var(--accent);
            color: var(--bg);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { opacity: 0.9; }
        .typing {
            display: none;
            gap: 5px;
            padding: 10px;
        }
        .typing.active { display: flex; }
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            animation: bounce 1.4s infinite;
        }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">üß† MORDZIX AI - FULL POWER</div>
        <div class="stats" id="stats">≈Åadowanie...</div>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <button class="new-chat" onclick="newConversation()">‚ûï Nowa rozmowa</button>
            <div id="conversations"></div>
        </div>
        
        <div class="main">
            <div class="messages" id="messages"></div>
            <div class="typing" id="typing">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
            <div class="input-area">
                <div class="input-wrap">
                    <textarea id="input" placeholder="Napisz wiadomo≈õƒá..."></textarea>
                    <button onclick="send()">‚ñ∂ Wy≈õlij</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PERSISTENT STORAGE - NIE KASUJE PO REFRESH!
        const STORAGE_KEY = 'mordzix_conversations';
        let conversations = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        let currentId = localStorage.getItem('current_conv') || null;

        // Initialize
        if (conversations.length === 0) {
            newConversation();
        } else {
            loadConversation(currentId || conversations[0].id);
        }

        // Load stats
        fetch('/api/chat/assistant/status')
            .then(r => r.json())
            .then(data => {
                document.getElementById('stats').textContent = 
                    `‚úÖ Online ‚Ä¢ ${data.features?.length || 6} Features ‚Ä¢ Model: ${data.model}`;
            })
            .catch(() => {
                document.getElementById('stats').textContent = '‚ö† Connecting...';
            });

        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(conversations));
            localStorage.setItem('current_conv', currentId);
        }

        function newConversation() {
            const id = Date.now().toString();
            conversations.unshift({
                id: id,
                title: 'Nowa rozmowa',
                messages: [],
                created: Date.now()
            });
            currentId = id;
            saveToStorage();
            renderConversations();
            renderMessages();
        }

        function loadConversation(id) {
            currentId = id;
            saveToStorage();
            renderMessages();
        }

        function renderConversations() {
            const div = document.getElementById('conversations');
            div.innerHTML = conversations.map(conv => `
                <div class="conv-item" onclick="loadConversation('${conv.id}')">
                    <strong>${conv.title}</strong>
                    <div style="font-size: 12px; color: var(--dim); margin-top: 5px;">
                        ${conv.messages.length} wiadomo≈õci
                    </div>
                </div>
            `).join('');
        }

        function renderMessages() {
            const conv = conversations.find(c => c.id === currentId);
            if (!conv) return;

            const div = document.getElementById('messages');
            div.innerHTML = conv.messages.map(msg => `
                <div class="msg ${msg.role}">
                    <div class="avatar">${msg.role === 'user' ? 'üë§' : 'ü§ñ'}</div>
                    <div class="content">${escapeHtml(msg.content)}</div>
                </div>
            `).join('');
            div.scrollTop = div.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        function addMessage(role, content) {
            const conv = conversations.find(c => c.id === currentId);
            if (!conv) return;

            conv.messages.push({ role, content, timestamp: Date.now() });
            
            // Update title from first message
            if (conv.messages.length === 1 && role === 'user') {
                conv.title = content.slice(0, 50) + (content.length > 50 ? '...' : '');
            }
            
            saveToStorage();
            renderMessages();
            renderConversations();
        }

        async function send() {
            const input = document.getElementById('input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            addMessage('user', message);
            
            document.getElementById('typing').classList.add('active');

            try {
                const conv = conversations.find(c => c.id === currentId);
                const response = await fetch('/api/chat/assistant', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        conversation_history: conv.messages.slice(-10),
                        settings: {
                            model: 'gpt-4-turbo-preview',
                            temperature: 0.7,
                            useMemory: true,
                            useResearch: true
                        }
                    })
                });

                const data = await response.json();
                addMessage('assistant', data.response || data.message || 'Brak odpowiedzi');

            } catch (error) {
                addMessage('assistant', '‚ùå B≈ÇƒÖd: ' + error.message);
            } finally {
                document.getElementById('typing').classList.remove('active');
            }
        }

        // Enter to send
        document.getElementById('input').addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                send();
            }
        });

        // Initial render
        renderConversations();
        renderMessages();

        console.log('üî• Mordzix AI FULL POWER loaded');
        console.log('üíæ Persistent storage: ENABLED');
        console.log('üìä Conversations saved:', conversations.length);
    </script>
</body>
</html>
